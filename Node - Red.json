[
    {
        "id": "b3e6843bda8a04fd",
        "type": "ui_template",
        "z": "b4499dccbe5dcdeb",
        "group": "e7684cef5a03ae2b",
        "name": "DASHBOARD HTML/JS/CSS",
        "order": 1,
        "width": "18",
        "height": "16",
        "format": "<link href=\"https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap\" rel=\"stylesheet\">\n<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n\n<style>\n    /* ... (Le CSS reste identique, je le garde compact pour la réponse) ... */\n    :root { --primary: #4361ee; --secondary: #3f37c9; --accent: #4cc9f0; --success: #06d6a0; --warning: #f72585; --danger: #ef233c; --dark: #1e293b; --light: #f8f9fa; --card-bg: rgba(255, 255, 255, 0.85); --text-main: #2b2d42; --text-sec: #8d99ae; --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); --border: 1px solid rgba(255, 255, 255, 0.18); }\n    [data-theme=\"dark\"] { --light: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text-main: #f1f5f9; --text-sec: #94a3b8; --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }\n\n    .dashboard-container {\n        font-family: 'Poppins', sans-serif;\n        background-color: var(--light);\n        background-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%), \n                          radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%), \n                          radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);\n        background-attachment: fixed;\n        background-size: cover;\n        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; overflow-y: auto; padding: 20px; box-sizing: border-box;\n        color: var(--text-main); transition: background-color 0.3s ease;\n    }\n    body { margin: 0; padding: 0; }\n    .navbar { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 15px 30px; border-radius: 20px; border: var(--border); box-shadow: var(--shadow); margin-bottom: 25px; }\n    .brand { font-size: 1.5rem; font-weight: 700; background: linear-gradient(45deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; }\n    .nav-tools { display: flex; align-items: center; gap: 20px; }\n    .theme-switch { position: relative; width: 60px; height: 30px; }\n    .theme-switch input { opacity: 0; width: 0; height: 0; }\n    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }\n    .slider:before { position: absolute; content: \"\"; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }\n    input:checked+.slider { background-color: var(--primary); }\n    input:checked+.slider:before { transform: translateX(30px); }\n    .signal-box { text-align: right; }\n    .signal-bars { display: flex; gap: 4px; justify-content: flex-end; }\n    .bar { width: 6px; height: 18px; background: #cbd5e1; border-radius: 3px; transition: 0.3s; }\n    .sig-bad .bar:nth-child(1) { background: var(--danger); }\n    .sig-med .bar:nth-child(-n+2) { background: var(--warning); }\n    .sig-good .bar:nth-child(-n+4) { background: var(--success); }\n    .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }\n    @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }\n    .glass-card { background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 24px; border: var(--border); box-shadow: var(--shadow); padding: 25px; position: relative; overflow: hidden; }\n    .bpm-wrapper { text-align: center; padding: 20px 0; }\n    .heart-container { position: relative; height: 100px; display: flex; justify-content: center; align-items: center; }\n    .fa-heart { font-size: 5rem; color: rgba(239, 35, 60, 0.2); transition: 0.2s; }\n    .beat-animation { animation: beat 1s infinite; color: var(--danger); filter: drop-shadow(0 0 15px rgba(239, 35, 60, 0.6)); }\n    @keyframes beat { 0%, 60% { transform: scale(1); } 15% { transform: scale(1.25); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } }\n    .bpm-value { font-size: 5rem; font-weight: 800; line-height: 1; color: var(--text-main); margin-top: 10px; }\n    .bpm-unit { font-size: 1.2rem; font-weight: 500; color: var(--text-sec); letter-spacing: 2px; }\n    .stat-row { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 0, 0, 0.1); }\n    .stat-item { text-align: center; }\n    .stat-val { font-size: 1.4rem; font-weight: 700; color: var(--text-main); }\n    .stat-label { font-size: 0.8rem; color: var(--text-sec); }\n    .alert-overlay { background: rgba(239, 35, 60, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 15px; border-radius: 12px; margin-top: 20px; display: none; animation: flash 2s infinite; }\n    @keyframes flash { 50% { opacity: 0.6; } }\n    .controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }\n    .date-inputs { display: flex; gap: 10px; flex-wrap: wrap; }\n    input[type=datetime-local] { background: rgba(255, 255, 255, 0.5); border: 1px solid #ccc; padding: 8px 12px; border-radius: 8px; color: var(--text-main); font-family: inherit; }\n    .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }\n    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); }\n    .btn-success { background: linear-gradient(135deg, var(--success), #05c493); }\n    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }\n    .mini-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n    .mini-card { background: rgba(255, 255, 255, 0.5); padding: 15px; border-radius: 12px; text-align: center; }\n    .mini-card h4 { margin: 0; font-size: 0.8rem; color: var(--text-sec); }\n    .mini-card div { font-size: 1.5rem; font-weight: 700; color: var(--primary); }\n    .chart-container { height: 300px; width: 100%; position: relative; }\n    .table-responsive { max-height: 250px; overflow-y: auto; margin-top: 20px; border-radius: 12px; }\n    table { width: 100%; border-collapse: collapse; }\n    th { position: sticky; top: 0; background: var(--card-bg); padding: 12px; text-align: left; color: var(--text-sec); font-size: 0.85rem; backdrop-filter: blur(5px); z-index: 1; }\n    td { padding: 12px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); color: var(--text-main); font-size: 0.9rem; }\n    tr:hover { background: rgba(0, 0, 0, 0.02); }\n</style>\n\n<div class=\"dashboard-container\" id=\"app-container\">\n    <nav class=\"navbar\">\n        <div class=\"brand\">\n            <i class=\"fa-solid fa-heart-pulse\"></i> Holter Pro\n            <span style=\"font-size:0.5em; opacity:0.6; margin-left:5px;\">V2.2 HRV</span>\n        </div>\n        <div class=\"nav-tools\">\n            <div class=\"signal-box\">\n                <div style=\"font-size:0.7em; color:var(--text-sec);\" id=\"rssi-text\">Recherche...</div>\n                <div class=\"signal-bars\" id=\"sig-bars\">\n                    <div class=\"bar\"></div>\n                    <div class=\"bar\"></div>\n                    <div class=\"bar\"></div>\n                    <div class=\"bar\"></div>\n                </div>\n            </div>\n            <label class=\"theme-switch\">\n                <input type=\"checkbox\" id=\"theme-toggle\">\n                <span class=\"slider\"></span>\n            </label>\n        </div>\n    </nav>\n\n    <div class=\"main-grid\">\n        <div class=\"glass-card\">\n            <div style=\"display:flex; justify-content:space-between; align-items:center;\">\n                <h3 style=\"margin:0; color:var(--text-sec);\">LIVE</h3>\n                <span style=\"background:var(--success); color:white; padding:2px 8px; border-radius:10px; font-size:0.7em;\">En ligne</span>\n            </div>\n\n            <div class=\"bpm-wrapper\">\n                <div class=\"heart-container\">\n                    <i id=\"heart-icon\" class=\"fa-solid fa-heart\"></i>\n                </div>\n                <div class=\"bpm-value\" id=\"bpm-val\">--</div>\n                <div class=\"bpm-unit\">BPM</div>\n            </div>\n\n            <div class=\"alert-overlay\" id=\"alert-box\">\n                <i class=\"fa-solid fa-triangle-exclamation\"></i> <span id=\"alert-msg\">ANOMALIE DÉTECTÉE</span>\n            </div>\n\n            <div class=\"stat-row\">\n                <div class=\"stat-item\">\n                    <div class=\"stat-val\" id=\"hrv-val\">--</div>\n                    <div class=\"stat-label\">HRV (ms)</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-val\" id=\"last-update\">--:--</div>\n                    <div class=\"stat-label\">Dernière MàJ</div>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"glass-card\">\n            <div class=\"controls-header\">\n                <h3 style=\"margin:0; color:var(--text-main);\">Analyse Historique</h3>\n                <div class=\"date-inputs\">\n                    <input type=\"datetime-local\" id=\"d-start\">\n                    <input type=\"datetime-local\" id=\"d-end\">\n                    <button class=\"btn btn-primary\" id=\"filter-btn\">\n                        <i class=\"fa-solid fa-filter\"></i> Filtrer\n                    </button>\n                    <button class=\"btn btn-success\" id=\"export-btn\">\n                        <i class=\"fa-solid fa-download\"></i> CSV\n                    </button>\n                </div>\n            </div>\n\n            <div class=\"mini-stats-grid\">\n                <div class=\"mini-card\">\n                    <h4>Moyenne BPM</h4>\n                    <div id=\"stat-avg\">--</div>\n                </div>\n                <div class=\"mini-card\">\n                    <h4>Minimum BPM</h4>\n                    <div id=\"stat-min\" style=\"color:var(--success)\">--</div>\n                </div>\n                <div class=\"mini-card\">\n                    <h4>Maximum BPM</h4>\n                    <div id=\"stat-max\" style=\"color:var(--danger)\">--</div>\n                </div>\n            </div>\n\n            <div class=\"chart-container\">\n                <canvas id=\"ecgChart\"></canvas>\n            </div>\n\n            <div class=\"table-responsive\">\n                <table id=\"data-table\">\n                    <thead>\n                        <tr>\n                            <th>Date & Heure</th>\n                            <th>Fréquence (BPM)</th>\n                            <th>HRV (ms)</th> <th>État</th>\n                        </tr>\n                    </thead>\n                    <tbody id=\"table-body\"></tbody>\n                </table>\n            </div>\n        </div>\n    </div>\n</div>\n\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js\"></script>\n<script>\n(function(scope) {\n    // Gestion du thème\n    const themeToggle = document.getElementById('theme-toggle');\n    const appContainer = document.getElementById('app-container');\n    \n    themeToggle.addEventListener('change', function() {\n        if (this.checked) {\n            appContainer.setAttribute('data-theme', 'dark');\n        } else {\n            appContainer.removeAttribute('data-theme');\n        }\n    });\n\n    // Initialisation Chart.js\n    const ctx = document.getElementById('ecgChart');\n    let chart = null;\n    \n    if (ctx) {\n        chart = new Chart(ctx.getContext('2d'), {\n            type: 'line',\n            data: {\n                labels: [],\n                datasets: [{\n                    label: 'Fréquence Cardiaque',\n                    data: [],\n                    borderColor: '#4361ee',\n                    backgroundColor: 'rgba(67, 97, 238, 0.1)',\n                    borderWidth: 2,\n                    fill: true,\n                    tension: 0.4,\n                    pointRadius: 2\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                scales: {\n                    y: { \n                        beginAtZero: false,\n                        grid: { color: 'rgba(0,0,0,0.05)' }\n                    },\n                    x: { \n                        grid: { display: false }\n                    }\n                },\n                plugins: { \n                    legend: { display: false }\n                },\n                animation: { duration: 0 }\n            }\n        });\n    }\n\n    // Dates par défaut\n    const now = new Date();\n    const tzOffset = now.getTimezoneOffset() * 60000;\n    const localEnd = (new Date(Date.now() - tzOffset)).toISOString().slice(0, 16);\n    const localStart = (new Date(Date.now() - 3600000 - tzOffset)).toISOString().slice(0, 16);\n    \n    document.getElementById('d-end').value = localEnd;\n    document.getElementById('d-start').value = localStart;\n\n    // Export CSV\n    document.getElementById('export-btn').addEventListener('click', function() {\n        const csv = [];\n        const rows = document.querySelectorAll(\"#data-table tr\");\n        \n        for (let i = 0; i < rows.length; i++) {\n            const row = [];\n            const cols = rows[i].querySelectorAll(\"td, th\");\n            for (let j = 0; j < cols.length; j++) {\n                row.push(cols[j].innerText);\n            }\n            csv.push(row.join(\",\"));\n        }\n\n        const csvFile = new Blob([csv.join(\"\\n\")], {type: \"text/csv\"});\n        const downloadLink = document.createElement(\"a\");\n        downloadLink.download = 'rapport_ecg.csv';\n        downloadLink.href = window.URL.createObjectURL(csvFile);\n        downloadLink.style.display = \"none\";\n        document.body.appendChild(downloadLink);\n        downloadLink.click();\n        document.body.removeChild(downloadLink);\n    });\n\n    // Bouton filtrer\n    document.getElementById('filter-btn').addEventListener('click', function() {\n        const start = document.getElementById('d-start').value;\n        const end = document.getElementById('d-end').value;\n        scope.send({ topic: \"query\", payload: { start: start, end: end } });\n    });\n\n    // Watch des messages\n    scope.$watch('msg', function(msg) {\n        if (!msg || !msg.payload) return;\n\n        // Données LIVE\n        if (msg.payload.type === 'live') {\n            const d = msg.payload;\n            \n            document.getElementById('bpm-val').innerText = d.bpm || '--';\n            document.getElementById('hrv-val').innerText = d.hrv || '--';\n            document.getElementById('last-update').innerText = d.time ? d.time.slice(0, 5) : '--:--';\n\n            // Animation cœur\n            const heart = document.getElementById('heart-icon');\n            if (d.bpm) {\n                heart.className = \"fa-solid fa-heart beat-animation\";\n                heart.style.animationDuration = (60 / d.bpm) + \"s\";\n            }\n\n            // GESTION ALERTE (VIA MQTT)\n            const alertBox = document.getElementById('alert-box');\n            \n            if (d.isAlert === true) {\n                alertBox.style.display = 'block';\n                document.getElementById('alert-msg').innerText = \"ANOMALIE DÉTECTÉE\";\n            } else {\n                alertBox.style.display = 'none';\n            }\n\n            // Signal RSSI\n            const bars = document.getElementById('sig-bars');\n            const txt = document.getElementById('rssi-text');\n            if (d.rssi) {\n                txt.innerText = d.rssi + \" dBm\";\n                bars.className = \"signal-bars\";\n                \n                if (d.rssi > -100) bars.classList.add('sig-good');\n                else if (d.rssi > -120) bars.classList.add('sig-med');\n                else bars.classList.add('sig-bad');\n            }\n        }\n\n        // Données HISTORIQUE\n        if (Array.isArray(msg.payload)) {\n            const data = msg.payload;\n            const tbody = document.getElementById('table-body');\n            tbody.innerHTML = \"\";\n            \n            const labels = [];\n            const values = [];\n            let min = 200, max = 0, sum = 0;\n\n            for (let i = 0; i < data.length; i++) {\n                const row = data[i];\n                const val = parseFloat(row.BPM || row.bpm || 0);\n                // On lit le HRV (avec protection si null)\n                const hrvVal = row.HRV ? parseFloat(row.HRV).toFixed(1) : '--';\n\n                if (val < min) min = val;\n                if (val > max) max = val;\n                sum += val;\n\n                const tr = document.createElement('tr');\n                \n                // État basé sur le champ Alert\n                const isAlert = (row.Alert == 1 || row.Alert === true);\n                const statusBadge = isAlert ? \n                    '<span style=\"color:#ef233c; font-weight:bold\"><i class=\"fa-solid fa-circle-exclamation\"></i> ALERTE</span>' : \n                    '<span style=\"color:#06d6a0; font-weight:bold\">Normal</span>';\n                \n                // On ajoute la cellule HRV dans la ligne\n                tr.innerHTML = `<td>${row.time || ''}</td><td><strong>${val}</strong></td><td>${hrvVal}</td><td>${statusBadge}</td>`;\n                tbody.appendChild(tr);\n\n                labels.unshift(row.time || '');\n                values.unshift(val);\n            }\n\n            // Mise à jour graphique\n            if (chart) {\n                chart.data.labels = labels;\n                chart.data.datasets[0].data = values;\n                chart.update();\n            }\n\n            // Stats\n            if (data.length > 0) {\n                document.getElementById('stat-min').innerText = min;\n                document.getElementById('stat-max').innerText = max;\n                document.getElementById('stat-avg').innerText = (sum / data.length).toFixed(1);\n            }\n        }\n    });\n})(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 80,
        "wires": [
            [
                "ed3b0b8d7223d3ce"
            ]
        ]
    },
    {
        "id": "e7684cef5a03ae2b",
        "type": "ui_group",
        "name": "Interface Principale",
        "tab": "86fbf1bbc138b530",
        "order": 1,
        "disp": false,
        "width": "18",
        "collapse": false
    },
    {
        "id": "86fbf1bbc138b530",
        "type": "ui_tab",
        "name": "Supervision Pro",
        "icon": "fa-heartbeat",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "243724d01ef54f48",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-dashboard": "3.6.6"
        }
    }
]